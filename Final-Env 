#!/usr/bin/env bash
set -euo pipefail

echo "This script assumes cluster-admin privileges."
echo "Current user: $(oc whoami || echo UNKNOWN)"
echo

########################
# Helper function
########################
ensure_project() {
  local ns="$1"
  if ! oc get ns "$ns" >/dev/null 2>&1; then
    echo ">> Creating project: $ns"
    # new-project may fail if self-provisioner removed; fall back to namespace creation
    oc new-project "$ns" >/dev/null 2>&1 || oc create namespace "$ns" >/dev/null 2>&1 || true
  else
    echo ">> Project $ns already exists"
  fi
}

########################
# Download Script file
# mkdir /root/certificates
# cd /root/certificates
# wget -O certificate-cmd "https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/network-policy-lab/certificate-gen.sh?inline=false"
########################
# Base projects
########################
#for ns in apollo test demo rocky darpa; do
for ns in rocky darpa; do
  ensure_project "$ns"
done

########################
# world (scaling base)
########################
ensure_project world
oc -n world create deployment web   --image=quay.io/redhattraining/hello-world-nginx:v1.0   --replicas=1 >/dev/null 2>&1 || true
oc -n world expose deployment web --port=8080 >/dev/null 2>&1 || true

########################
# scaling (HPA base)
########################
ensure_project scaling
oc -n scaling create deployment autoscale-app   --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n scaling set resources deployment autoscale-app   --requests=cpu=50m,memory=100Mi >/dev/null 2>&1 || true
oc -n scaling expose deployment autoscale-app --port=8080 >/dev/null 2>&1 || true

########################
# math (secrets)
########################
ensure_project math
oc adm policy add-scc-to-user anyuid -z default -n math
oc -n math create deployment math-app --image=mysql
########################
# monday (secret consumption)
########################
ensure_project monday
oc -n monday create deployment monday-app   --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n monday expose deployment monday-app --port=8080 >/dev/null 2>&1 || true

########################
# quart (TLS route)
########################
rm -rf /usr/local/bin/cert-cmd
echo 'openssl genrsa -out tls.key 4096' >>/usr/local/bin/cert-cmd
echo 'openssl req -new -key tls.key -out tls.csr'>>/usr/local/bin/cert-cmd
echo 'openssl x509 -req -in tls.csr -signkey tls.key -out tls.crt'>>/usr/local/bin/cert-cmd

ensure_project quart
oc -n quart create deployment hello   --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n quart expose deployment hello --port=8080 >/dev/null 2>&1 || true
oc expose svc hello --name=quart-route
########################
# qed (SCC / anyuid)
########################
ensure_project qed
oc create deployment qed-app --image=nginx --labels=app=myapp>/dev/null 2>&1 || true
wget -O qed-service.yaml https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/Evaluation/qed-service.yaml?inline=false>/dev/null 2>&1 || true
oc apply -f qed-service.yaml>/dev/null 2>&1 || true
oc -n qed expose deployment qed-app --port=80 >/dev/null 2>&1 || true

########################
# etherpad
########################
ensure_project etherpad

########################
# cron-test
########################
ensure_project cron-test

########################
# page (PV/PVC lab)
########################
ensure_project page

########################
# project-b (network policy)
########################
ensure_project project-b
ensure_project project-a
oc adm policy add-scc-to-user anyuid -z default -n project-a
oc adm policy add-scc-to-user anyuid -z default -n project-b
oc label ns project-b team=devsecops --overwrite >/dev/null 2>&1 || true
rm -rf network-policy-files
mkdir network-policy-files
cd network-policy-files
wget -O mysql-deployment.yaml "https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/network-policy-lab/mysql-deployment.yaml?inline=false"
wget -O wordpress-deployment.yaml "https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/network-policy-lab/wordpress-deployment.yaml?inline=false"
wget -O mysql-service.yaml "https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/network-policy-lab/mysql-service.yaml?inline=false"
wget -O network-policy.yaml "https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/network-policy-lab/network-policy.yaml?inline=false"

oc apply -f .

########################
# Tuesday: LivenessProbe (DO NOT block the script)
# NOTE: If your cluster doesn't have this namespace yet, we skip instead of failing.
########################
ensure_project tuesday
  oc adm policy add-scc-to-user anyuid -z default -n tuesday
  oc -n tuesday create deployment liveness-app --image=nginx >/dev/null 2>&1 || true
  oc -n tuesday set ports deployment/liveness-app --container-port=80 >/dev/null 2>&1 || true
  oc -n tuesday set probe deployment/liveness-app     --liveness --get-url=http://:80/     --initial-delay-seconds=10 --period-seconds=10 >/dev/null 2>&1 || true
  oc -n tuesday expose deployment liveness-app --port=80 >/dev/null 2>&1 || true
  oc -n tuesday expose svc liveness-app >/dev/null 2>&1 || true


########################
# TROUBLESHOOTING LABS
########################

# troubleshooting-1 (selector)
ensure_project troubleshooting-1
oc adm policy add-scc-to-user anyuid -z default -n troubleshooting-1 >/dev/null 2>&1 || true
wget -q -O selector.yaml   https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/Evaluation/selector.yaml || true
oc apply -f selector.yaml -n troubleshooting-1 >/dev/null 2>&1 || true

# troubleshooting-2 (service selector)
ensure_project troubleshooting-2
oc adm policy add-scc-to-user anyuid -z default -n troubleshooting-2 >/dev/null 2>&1 || true
wget -q -O service-selector.yaml   https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/Evaluation/service-selector.yaml || true
oc apply -f service-selector.yaml -n troubleshooting-2 >/dev/null 2>&1 || true

# troubleshooting-3 (memory / OOM)
ensure_project troubleshooting-3
oc adm policy add-scc-to-user anyuid -z default -n troubleshooting-3 >/dev/null 2>&1 || true
wget -q -O memory.yaml   https://gitlab.com/zeeshanali.ny/ocp-labs/-/raw/main/Evaluation/memory.yaml || true
oc apply -f memory.yaml -n troubleshooting-3 >/dev/null 2>&1 || true

echo
echo "âœ… EX280 FULL LAB ENVIRONMENT SETUP COMPLETE"
echo ">> Verify troubleshooting namespaces:"
oc get ns | egrep 'troubleshooting-1|troubleshooting-2|troubleshooting-3' || true
