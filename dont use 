#!/usr/bin/env bash
set -euo pipefail

echo "This script assumes you are logged into an OpenShift cluster with cluster-admin privileges."
echo "Current user: $(oc whoami || echo 'UNKNOWN')"
echo

########################
# Helper: create project
########################
ensure_project() {
  local ns="$1"
  if ! oc get ns "$ns" >/dev/null 2>&1; then
    echo ">> Creating project: $ns"
    oc new-project "$ns" >/dev/null 2>/dev/null || oc create namespace "$ns" >/dev/null 2>&1
  else
    echo ">> Project $ns already exists, skipping"
  fi
}

############################
# Q2/Q3: Base RBAC projects
############################
for ns in apollo test demo; do
  ensure_project "$ns"
done

########################
# Q4: project rocky
########################
ensure_project rocky

########################
# Q5: project darpa
########################
ensure_project darpa

########################
# Q6: project world
# - Create a single-pod deployment to scale later
########################
ensure_project world
echo ">> Creating base deployment in 'world' for scaling task (Q6)"
oc -n world create deployment web --image=quay.io/redhattraining/hello-world-nginx:v1.0 --replicas=1 >/dev/null 2>&1 || true
oc -n world expose deployment web --port=8080 --target-port=8080 >/dev/null 2>&1 || true

########################
# Q7: project scaling
# - Create deployment with resource requests; you'll attach HPA later
########################
ensure_project scaling
echo ">> Creating base deployment in 'scaling' for HPA task (Q7)"
oc -n scaling create deployment autoscale-app --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n scaling set resources deployment autoscale-app --requests='cpu=50m,memory=100Mi' >/dev/null 2>&1 || true
oc -n scaling expose deployment autoscale-app --port=8080 --target-port=8080 >/dev/null 2>&1 || true

########################
# Q8: project math
########################
ensure_project math
echo ">> Project 'math' ready for Secret creation (Q8). You will create 'magic' yourself."

########################
# Q9: project monday
# - Create a pod/deployment that you will later modify to use 'magic' secret
########################
ensure_project monday
echo ">> Creating base deployment in 'monday' for Secret consumption task (Q9)"
oc -n monday create deployment monday-app --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n monday expose deployment monday-app --port=8080 --target-port=8080 >/dev/null 2>&1 || true

########################
# Q10: project quart
# - App 'hello' already running over HTTP
########################
ensure_project quart
echo ">> Creating 'hello' app in 'quart' for secure Route task (Q10)"
oc -n quart create deployment hello --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n quart expose deployment hello --port=8080 --target-port=8080 >/dev/null 2>&1 || true

########################
# Q11/Q12: project qed
# - Create a base app that you will later run under SA with anyuid
########################
ensure_project qed
echo ">> Creating base deployment in 'qed' for SA/anyuid task (Q11/Q12)"
oc -n qed create deployment qed-app --image=quay.io/redhattraining/hello-world-nginx:v1.0 >/dev/null 2>&1 || true
oc -n qed expose deployment qed-app --port=8080 --target-port=8080 >/dev/null 2>&1 || true
# Create the ServiceAccount now, but DO NOT grant anyuid yet (pod should fail until Q11/Q12 is done)
oc -n qed create sa project1-sa >/dev/null 2>&1 || true
oc -n qed set serviceaccount deployment/qed-app project1-sa >/dev/null 2>&1 || true

# Force the pod to request UID 0 so it is blocked by default SCC (will run only after anyuid SCC is granted)
oc -n qed patch deployment qed-app --type='json' -p='[
  {"op":"add","path":"/spec/template/spec/containers/0/securityContext","value":{"runAsUser":0}}
]' >/dev/null 2>&1 || true

# Restart to apply
oc -n qed rollout restart deployment/qed-app >/dev/null 2>&1 || true
echo ">> You will create ServiceAccount 'project1-sa' and bind anyuid SCC later."

########################
# Q13: Helm repo
# - We can't enforce the repo, but we can create a namespace for etherpad install
########################
ensure_project etherpad
echo ">> Project 'etherpad' created. You will configure Helm and install the chart (Q13)."

########################
# Q14: project cron-test
########################
ensure_project cron-test
echo ">> Project 'cron-test' ready for CronJob task (Q14)."

########################
# Q15: project template / global template
# - Nothing to create here; you will define a template & annotate cluster
########################
echo ">> Q15: You will create a project template and set annotations on projectRequestTemplate yourself."

########################
# Q16: operator namespace
########################
ensure_project openshift-file-integrity
echo ">> Project 'openshift-file-integrity' created for File Integrity Operator (Q16). Operator install is manual."

########################
# Q18: PV / PVC / Nginx in 'page'
########################
ensure_project page
echo ">> Project 'page' ready for PV/PVC + nginx app (Q18)."
echo "   NOTE: This script does NOT create the NFS server or StorageClass 'nfs2'. You will create the PV/PVC yourself."


########################
# Extra: project-b label (some NetworkPolicy tasks select namespaces by label)
########################
ensure_project project-b
oc label ns project-b team=devsecops --overwrite >/dev/null 2>&1 || true

########################
# Q20: NetworkPolicy between 'database' and 'checker'
########################
ensure_project database
ensure_project checker

echo ">> Lab setup for NetworkPolicy (Q20):"
echo "   - Creating deployment 'web-mysq' in 'database' with label deployment=web-mysq and namespace label team=devsecops"
# Label the database namespace
oc label ns database team=devsecops --overwrite >/dev/null 2>&1 || true

# Create the DB-like deployment
oc -n database create deployment web-mysq --image=quay.io/centos/centos:7 >/dev/null 2>&1 || true
oc -n database set labels deployment web-mysq deployment=web-mysq >/dev/null 2>&1 || true
# Add a simple TCP listener on 3306 using nc (for simulation)
oc -n database set env deployment/web-mysq LISTEN_PORT=3306 >/dev/null 2>&1 || true
oc -n database patch deployment web-mysq --type='json' -p='[
  {"op": "replace", "path": "/spec/template/spec/containers/0/command", "value": ["bash","-c","yum install -y nc && nc -lk -p 3306"] }
]' >/dev/null 2>&1 || true

echo "   - Creating 'checker' pod in 'checker' namespace to test MySQL connectivity"
oc -n checker run checker --image=quay.io/centos/centos:7 --restart=Never --command -- bash -c "sleep 3600" >/dev/null 2>&1 || true

########################
# Q21: Liveness probe in 'tuesday'
# - Create an app listening on 8443
########################
ensure_project tuesday
echo ">> Creating app 'probe-app' in 'tuesday' listening on 8443 for liveness probe task (Q21)"
oc adm policy add-scc-to-user anyuid -z default -n tuesday
oc -n tuesday create deployment probe-app --image nginx

########################
# Tuesday: LivenessProbe (port 80)
# Project already exists: file-integrity-project
# No application exists initially â†’ create one
########################

echo ">> Tuesday LivenessProbe setup in file-integrity-project"

# Switch to existing project (DO NOT create it)
oc project file-integrity-project >/dev/null 2>&1 || {
  echo "ERROR: file-integrity-project does not exist or access denied"
  exit 1
}

# Create application (nginx) since no app exists
if ! oc get deployment liveness-app >/dev/null 2>&1; then
  oc create deployment liveness-app --image=nginx
fi

# Ensure container listens on port 80
oc set ports deployment/liveness-app --container-port=80 >/dev/null 2>&1

# Configure livenessProbe on port 80
oc set probe deployment/liveness-app   --liveness   --get-url=http://:80/   --initial-delay-seconds=10   --period-seconds=10   --timeout-seconds=2   --failure-threshold=3 >/dev/null 2>&1

# Restart deployment so probe & port apply
oc rollout restart deployment/liveness-app >/dev/null 2>&1

# Expose service on port 80
if ! oc get svc liveness-app >/dev/null 2>&1; then
  oc expose deployment liveness-app --port=80
fi

# Create route
if ! oc get route liveness-app >/dev/null 2>&1; then
  oc expose svc liveness-app
fi

echo ">> Tuesday LivenessProbe setup completed successfully"

